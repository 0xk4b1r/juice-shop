// Cross-Site Scripting (XSS) Vulnerabilities
const express = require('express');
const router = express.Router();

// VULNERABLE: Reflected XSS - User input directly rendered in response
router.get('/search', (req, res) => {
  const query = req.query.q;
  // Direct insertion of user input into HTML response
  res.send(`
    <html>
      <head><title>Search Results</title></head>
      <body>
        <h1>Search Results for: ${query}</h1>
        <p>No results found for "${query}"</p>
      </body>
    </html>
  `);
});

// VULNERABLE: Stored XSS - Unsanitized user input stored and displayed
const comments = [];

router.post('/comment', (req, res) => {
  const { username, comment } = req.body;
  // Storing unsanitized user input
  comments.push({
    username: username,
    comment: comment,
    timestamp: new Date()
  });
  res.json({ success: true });
});

router.get('/comments', (req, res) => {
  // Rendering unsanitized comments directly
  let html = '<html><body><h1>Comments</h1>';
  comments.forEach(c => {
    html += `<div class="comment">
      <strong>${c.username}</strong>: ${c.comment}
      <small>${c.timestamp}</small>
    </div>`;
  });
  html += '</body></html>';
  res.send(html);
});

// VULNERABLE: DOM-based XSS via innerHTML
router.get('/profile', (req, res) => {
  const name = req.query.name;
  res.send(`
    <html>
      <body>
        <div id="greeting"></div>
        <script>
          const name = "${name}";
          document.getElementById('greeting').innerHTML = 'Welcome, ' + name + '!';
        </script>
      </body>
    </html>
  `);
});

// VULNERABLE: XSS in error messages
router.get('/api/data', (req, res) => {
  const callback = req.query.callback;
  const data = { message: 'Hello World' };
  
  // JSONP callback without sanitization
  if (callback) {
    res.send(`${callback}(${JSON.stringify(data)})`);
  } else {
    res.json(data);
  }
});

// VULNERABLE: XSS via user-controlled href
router.get('/redirect', (req, res) => {
  const url = req.query.url;
  res.send(`
    <html>
      <body>
        <p>Click <a href="${url}">here</a> to continue</p>
        <script>
          // Also vulnerable to javascript: URLs
          window.location = "${url}";
        </script>
      </body>
    </html>
  `);
});

module.exports = router;
